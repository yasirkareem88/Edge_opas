#!/bin/bash

# OpenVPN AS Complete Installation Script
set -e

echo "=== OpenVPN AS Installation Started ==="

# Update system
echo "Updating system packages..."
apt update && apt upgrade -y

# Install prerequisites
echo "Installing prerequisites..."
apt install -y curl wget gnupg2 software-properties-common ufw nginx

# Configure firewall
echo "Configuring firewall..."
ufw allow ssh
ufw allow 8080/tcp
ufw allow 443/tcp
ufw allow 943/tcp
ufw allow 945/tcp
ufw allow 1194/udp
ufw --force enable

# Install OpenVPN Access Server
echo "Installing OpenVPN Access Server..."
wget -q https://as-repository.openvpn.net/as-repo-public.asc -O /etc/apt/trusted.gpg.d/as-repository.asc
echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/as-repository.asc] http://as-repository.openvpn.net/as/debian jammy main" > /etc/apt/sources.list.d/openvpn-as-repo.list

apt update
DEBIAN_FRONTEND=noninteractive apt install -y openvpn-as

# Configure OpenVPN AS
echo "Configuring OpenVPN AS..."
/usr/local/openvpn_as/scripts/confdba -mk "admin_ui.https.ip_address" -v "all"
/usr/local/openvpn_as/scripts/confdba -mk "cs.https.ip_address" -v "all"
/usr/local/openvpn_as/scripts/confdba -mk "vpn.server.port_share.enable" -v "false"

# Set admin password (change 'YourSecurePassword123!' to your password)
echo "openvpn:YourSecurePassword123!" | chpasswd

# Create Nginx configuration for port 8080
echo "Configuring Nginx..."
cat > /etc/nginx/sites-available/openvpn << 'EOF'
server {
    listen 8080;
    server_name _;
    
    location / {
        proxy_pass https://localhost:943;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF

# Enable site
ln -sf /etc/nginx/sites-available/openvpn /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

# Test and reload Nginx
nginx -t
systemctl reload nginx

# Restart OpenVPN AS
systemctl restart openvpnas

echo "=== Installation Complete ==="
echo "Web Interface: http://$(curl -s ifconfig.me):8080"
echo "Username: openvpn"
echo "Password: YourSecurePassword123!"
echo ""
echo "=== IMPORTANT ==="
echo "1. Change the default password immediately!"
echo "2. Configure your domain in Admin UI"
echo "3. Set up SSL certificates for production"
